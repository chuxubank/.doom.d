From e59840e1de58ae4d260f9718d03b5e41e27c933e Mon Sep 17 00:00:00 2001
From: Misaka <chuxubank@qq.com>
Date: Fri, 4 Sep 2020 13:20:02 +0800
Subject: [PATCH] Fix fd and ripgrep on wsl1

---
 core/core-projects.el                  | 4 ++--
 modules/completion/ivy/autoload/ivy.el | 3 ++-
 modules/completion/ivy/config.el       | 4 ++--
 3 files changed, 6 insertions(+), 5 deletions(-)

diff --git a/core/core-projects.el b/core/core-projects.el
index 061b6b9f..80fb5f51 100644
--- a/core/core-projects.el
+++ b/core/core-projects.el
@@ -178,12 +178,12 @@ And if it's a function, evaluate it."
                   (bin (if (ignore-errors (file-remote-p default-directory nil t))
                            (cl-find-if find-exe-fn (list "fdfind" "fd"))
                          doom-projectile-fd-binary))
-                (concat (format "%s . -0 -H -E .git --color=never --type file --type symlink --follow"
+                (concat (format "%s . -j1 -0 -H -E .git --color=never --type file --type symlink --follow"
                                 bin)
                         (if IS-WINDOWS " --path-separator=/"))))
              ;; Otherwise, resort to ripgrep, which is also faster than find
              ((funcall find-exe-fn "rg")
-              (concat "rg -0 --files --follow --color=never --hidden"
+              (concat "rg -j1 -0 --files --follow --color=never --hidden"
                       (cl-loop for dir in projectile-globally-ignored-directories
                                concat " --glob "
                                concat (shell-quote-argument (concat "!" dir)))
diff --git a/modules/completion/ivy/autoload/ivy.el b/modules/completion/ivy/autoload/ivy.el
index 6a18bc76..ea37ec40 100644
--- a/modules/completion/ivy/autoload/ivy.el
+++ b/modules/completion/ivy/autoload/ivy.el
@@ -270,7 +270,8 @@ The point of this is to avoid Emacs locking up indexing massive file trees."
   (let* ((this-command 'counsel-rg)
          (project-root (or (doom-project-root) default-directory))
          (directory (or in project-root))
-         (args (concat (if all-files " -uu")
+         (args (concat " -j1"
+                       (if all-files " -uu")
                        (unless recursive " --maxdepth 1")
                        " " (mapconcat #'shell-quote-argument args " "))))
     (setq deactivate-mark t)
diff --git a/modules/completion/ivy/config.el b/modules/completion/ivy/config.el
index 785a0fee..498eddfc 100644
--- a/modules/completion/ivy/config.el
+++ b/modules/completion/ivy/config.el
@@ -285,11 +285,11 @@ evil-ex-specific constructs, so we disable it solely in evil-ex."
     (cl-destructuring-bind (find-program . args)
         (cond ((when-let (fd (executable-find (or doom-projectile-fd-binary "fd")))
                  (append (list fd
-                               "--color=never" "-E" ".git"
+                               "-j1" "--color=never" "-E" ".git"
                                "--type" "file" "--type" "symlink" "--follow")
                          (if IS-WINDOWS '("--path-separator=/")))))
               ((executable-find "rg")
-               (append (list "rg" "--files" "--follow" "--color=never" "--hidden" "--no-messages")
+               (append (list "rg" "-j1" "--files" "--follow" "--color=never" "--hidden" "--no-messages")
                        (cl-loop for dir in projectile-globally-ignored-directories
                                 collect "--glob"
                                 collect (concat "!" dir))
-- 
2.28.0

